######################################################################
####                                                              ####
####  ORPSoC Altera Synthesis Makefile                            ####
####                                                              ####
####  Author(s):                                                  ####
####    - Stefan Kristiansson, stefan.kristiansson@saunalahti.fi  ####
####                                                              ####
####                                                              ####
######################################################################
####                                                              ####
#### Copyright (C) 2009,2010,2011 Authors and OPENCORES.ORG       ####
####                                                              ####
#### This source file may be used and distributed without         ####
#### restriction provided that this copyright statement is not    ####
#### removed from the file and that any derivative work contains  ####
#### the original copyright notice and the associated disclaimer. ####
####                                                              ####
#### This source file is free software; you can redistribute it   ####
#### and/or modify it under the terms of the GNU Lesser General   ####
#### Public License as published by the Free Software Foundation; ####
#### either version 2.1 of the License, or (at your option) any   ####
#### later version.                                               ####
####                                                              ####
#### This source is distributed in the hope that it will be       ####
#### useful, but WITHOUT ANY WARRANTY; without even the implied   ####
#### warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR      ####
#### PURPOSE.  See the GNU Lesser General Public License for more ####
#### details.                                                     ####
####                                                              ####
#### You should have received a copy of the GNU Lesser General    ####
#### Public License along with this source; if not, download it   ####
#### from http://www.opencores.org/lgpl.shtml                     ####
####                                                              ####
######################################################################

# Name of the directory we're currently in
CUR_DIR=$(shell pwd)

# The root path of the board build
BOARD_ROOT ?=$(CUR_DIR)/../../..
include $(BOARD_ROOT)/Makefile.inc

RTL_TOP ?=$(DESIGN_NAME)_top

SYN_RUN_DIR=$(BOARD_SYN_DIR)/run

TIMESCALE_FILE=timescale.v
SYNDIR_TIMESCALE_FILE=$(SYN_RUN_DIR)/$(TIMESCALE_FILE)
$(SYNDIR_TIMESCALE_FILE):
	$(Q)echo "" > $@

SYN_VERILOG_DEFINES=synthesis-defines.v
SYNDIR_SYN_VERILOG_DEFINES=$(SYN_RUN_DIR)/$(SYN_VERILOG_DEFINES)
$(SYNDIR_SYN_VERILOG_DEFINES):
	$(Q)echo "\`define SYNTHESIS" > $@
	$(Q)echo "\`define ALTERA" >> $@
	$(Q)echo "" >> $@

GENERATED_DEFINES = $(BOOTROM_VERILOG)
GENERATED_DEFINES += $(SYNDIR_TIMESCALE_FILE)
GENERATED_DEFINES += $(SYNDIR_SYN_VERILOG_DEFINES)
TCL_DIR=$(BOARD_SYN_DIR)/tcl
TCL_FILE=$(DESIGN_NAME).tcl
SDC_DIR=$(BOARD_SYN_DIR)/sdc
SDC_FILE=$(DESIGN_NAME).sdc

all: sta

$(TCL_FILE):
	$(Q)echo; echo "#### Generating TCL file ####"; echo
	$(Q)echo "# TCL Script for ORPSoC Synthesis" > $@
	$(Q)echo "# This file is autogenerated - any changes will be overwritten" >> $@
	$(Q)echo "# See the Makefile in syn/xst/bin to make changes" >> $@
	$(Q)echo "project_new $(DESIGN_NAME) -overwrite" >> $@
	$(Q)echo "set_global_assignment -name FAMILY \"$(FPGA_FAMILY)\"" >> $@
	$(Q)echo "set_global_assignment -name DEVICE $(FPGA_PART)" >> $@
	$(Q)echo "set_global_assignment -name TOP_LEVEL_ENTITY $(RTL_TOP)" >> $@
	$(Q)echo "set_global_assignment -name CYCLONEII_RESERVE_NCEO_AFTER_CONFIGURATION \"USE AS REGULAR IO\"" >> $@
	$(Q)echo "set_global_assignment -name AUTO_RAM_TO_LCELL_CONVERSION ON" >> $@
	$(Q)echo "set_instance_assignment -name AUTO_RAM_RECOGNITION OFF -to \"uart16550:uart16550_0|uart_regs:regs|uart_transmitter:transmitter|uart_tfifo:fifo_tx|raminfr:tfifo\"" >> $@
	$(Q)echo "set_instance_assignment -name AUTO_RAM_RECOGNITION OFF -to \"uart16550:uart16550_0|uart_regs:regs|uart_receiver:receiver|uart_rfifo:fifo_rx|raminfr:rfifo\"" >> $@
	$(Q)echo "set_global_assignment -name CYCLONEII_OPTIMIZATION_TECHNIQUE SPEED" >> $@

	$(Q)for file in $(RTL_VERILOG_SRC); do \
		echo "set_global_assignment -name VERILOG_FILE $$file" >> $@ ; \
	done
	$(Q)for file in $(BOARD_BACKEND_VERILOG_SRC); do \
		echo "set_global_assignment -name VERILOG_FILE $$file" >> $@ ; \
	done
	$(Q)for file in $(RTL_VHDL_SRC); do \
		echo "set_global_assignment -name VHDL_FILE $$file" >> $@ ; \
	done
	$(Q)echo "set_global_assignment -name SEARCH_PATH $(BOARD_RTL_VERILOG_INCLUDE_DIR)" >> $@
	$(Q)echo "set_global_assignment -name SEARCH_PATH $(COMMON_RTL_VERILOG_DIR)" >> $@
	$(Q)echo "set_global_assignment -name SEARCH_PATH $(BOOTROM_SW_DIR)" >> $@
	$(Q)echo "set_global_assignment -name SEARCH_PATH $(VERSATILE_MEM_INC_DIR)" >> $@
	$(Q)echo "set_global_assignment -name SDC_FILE $(DESIGN_NAME).sdc" >> $@
# Do pin assignments, first copy from the common pin assignment file,
# then check what peripherals are defined active and check if there are 
# any pin assignments files available for them
	$(Q)if [ -f $(TCL_DIR)/common_pin_assignments.tcl ]; then \
		cat $(TCL_DIR)/common_pin_assignments.tcl >> $@ ; \
	fi;
	$(Q)for define in $(DESIGN_DEFINES); do \
		if [ -f $(TCL_DIR)/$$define"_pin_assignments.tcl" ]; then \
			cat $(TCL_DIR)/$$define"_pin_assignments.tcl" >> $@ ; \
		fi; \
	done;
	$(Q)echo "project_close" >> $@
	$(Q)echo

$(SDC_FILE):
	$(Q)echo; echo "#### Generating SDC file ####"; echo
	$(Q)echo "# SDC file for ORPSoC" > $@
	$(Q)echo "# This file is autogenerated - any changes will be overwritten" >> $@
	$(Q)echo "# See the Makefile in syn/xst/bin to make changes" >> $@
	$(Q)if [ -f $(SDC_DIR)/common.sdc ]; then \
		cat $(SDC_DIR)/common.sdc >> $@ ; \
	fi;
	$(Q)for define in $(DESIGN_DEFINES); do \
		if [ -f $(SDC_DIR)/$$define".sdc" ]; then \
			cat $(SDC_DIR)/$$define".sdc" >> $@ ; \
		fi; \
	done;
	$(Q)echo

project: $(GENERATED_DEFINES) $(TCL_FILE) $(SDC_FILE)
	$(Q) echo "#### Generating project files ####"
	quartus_sh -t $(TCL_FILE)
pgm: 
	quartus_pgm --mode=jtag -o p\;$(DESIGN_NAME).sof

sta: asm
	quartus_sta $(DESIGN_NAME)

asm: fit
	quartus_asm $(DESIGN_NAME)

fit: map
	quartus_fit $(DESIGN_NAME)

map: project
	quartus_map $(DESIGN_NAME)
	
opt: $(DESIGN_NAME).sof
	echo "BITSTREAM_COMPRESSION=ON" > $(DESIGN_NAME).opt	

jic:$(DESIGN_NAME).sof opt
	quartus_cpf -c -o $(DESIGN_NAME).opt -d $(FLASH) -s $(FPGA_PART) $< $(DESIGN_NAME).jic

pof:	$(DESIGN_NAME).sof $(DESIGN_NAME).opt
	quartus_cpf -c -o $(DESIGN_NAME).opt -d $(FLASH) $< $(DESIGN_NAME).pof

rpd:	$(DESIGN_NAME).pof
	quartus_cpf -c -o $(DESIGN_NAME).opt $< $(DESIGN_NAME).rpd	
	
print-config:
	$(Q)echo; echo "### Synthesis make configuration ###"; echo
	$(Q)echo "FPGA_FAMILY="$(FPGA_FAMILY)
	$(Q)echo "FPGA_PART="$(FPGA_PART)
	$(Q)echo

clean:
	rm -rf *.* db incremental_db

clean-sw:
	$(MAKE) -C $(PROJECT_ROOT)/sw/lib distclean
	
pgm_hw: $(DESIGN_NAME).jic	
	quartus_pgm --mode=jtag -o pi\;$(DESIGN_NAME).jic

distclean: clean-sw clean


#bulid hw+sw image to EPCS64
#SW_ELF=uart-echo.elf
#SW_ELF=gpio-simple.elf
SW_ELF=u-boot
$(SW_ELF):
	#cp ../../../sim/run/$(SW_ELF) .
	rm -rf u-boot
	cp /home/ys/soc-design/u-boot-openrisc/u-boot .
	
# Build the image so we can boot it from the SPI flash
swimage.bin: $(SW_ELF)
	or32-elf-objcopy $(SW_ELF) -O binary $@

B2BSW_EXE = bin2binsizeword
B2BSW_DIR = $(PROJECT_ROOT)/sw/utils/
B2BSW     = $(B2BSW_DIR)/$(B2BSW_EXE)

$(B2BSW): 
	$(MAKE) -C $(B2BSW_DIR) $(B2BSW_EXE)

flashimage.bin: swimage.bin $(B2BSW)
	$(B2BSW) $< $@

flashimage.ihex:flashimage.bin
	or32-elf-objcopy -I binary -O ihex flashimage.bin flashimage.hex

pgm_hwsw:flashimage.ihex
	cp ../bin/de0_nano.cof .
	quartus_cpf -c de0_nano.cof
	quartus_pgm --mode=jtag -o pi\;de0_nano.jic


	



